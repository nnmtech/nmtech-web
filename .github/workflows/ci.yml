name: CI / Staging Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-deploy-test:
    runs-on: ubuntu-latest
    env:
      NODE_OPTIONS: --max_old_space_size=4096
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build (run your build command)
        run: |
          # Adjust if you have a specific build command
          if npm run | grep -q " build"; then
            npm run build
          else
            echo "No build script defined; ensure dist/ exists"
          fi

      - name: Compute SRI hashes
        id: sri
        run: |
          out=$(node scripts/compute_sri.js || true)
          echo "sri_output<<EOF" >> $GITHUB_OUTPUT
          echo "$out" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Parse SRI hashes
        id: parse_sri
        run: |
          echo "$SRI_OUTPUT"
          css_hash=$(echo "$SRI_OUTPUT" | awk -F": " '/css\/app.min.css/ {print $2}')
          js_hash=$(echo "$SRI_OUTPUT" | awk -F": " '/js\/app.min.js/ {print $2}')
          echo "css=$css_hash" >> $GITHUB_OUTPUT
          echo "js=$js_hash" >> $GITHUB_OUTPUT
        env:
          SRI_OUTPUT: ${{ steps.sri.outputs.sri_output }}

      - name: Update netlify.toml and index.html with SRI
        if: steps.parse_sri.outputs.css != '' && steps.parse_sri.outputs.js != ''
        run: |
          css=${{ steps.parse_sri.outputs.css }}
          js=${{ steps.parse_sri.outputs.js }}
          echo "Applying CSS SRI: $css"
          echo "Applying JS SRI: $js"
          sed -i "s/REPLACE_WITH_CSS_HASH/$css/g" netlify.toml || true
          sed -i "s/REPLACE_WITH_JS_HASH/$js/g" netlify.toml || true
          sed -i "s/sha384-[A-Za-z0-9+/=]\{20,\}/$css/1" index.html || true
          sed -i "s/sha384-[A-Za-z0-9+/=]\{20,\}/$js/2" index.html || true

      - name: Run tests
        run: npm test

      - name: Deploy to Netlify (staging draft)
        id: deploy
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm i -g netlify-cli jq
          deploy_json=$(netlify deploy --dir=dist --auth=$NETLIFY_AUTH_TOKEN --site=$NETLIFY_SITE_ID --message "CI staging deploy $GITHUB_SHA" --json)
          echo "$deploy_json" > deploy.json
          url=$(echo "$deploy_json" | jq -r '.url // .deploy_url // .deploy.ssl_url // .deploy_url')
          echo "deployed_url=$url" >> $GITHUB_OUTPUT

      - name: Run LHCI (Lighthouse CI)
        if: always()
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          url=${{ steps.deploy.outputs.deployed_url }}
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Deploy URL not available; skipping LHCI"
            exit 0
          fi
          npm i -g @lhci/cli
          npx lhci autorun --collect.url=$url --upload.target=temporary-public-storage

      - name: Run Lighthouse (single report)
        if: always()
        run: |
          url=${{ steps.deploy.outputs.deployed_url }}
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Deploy URL not available; skipping Lighthouse"
            exit 0
          fi
          npm i -g lighthouse
          npx lighthouse "$url" --quiet --output=json --output-path=lh-report.json --chrome-flags="--headless --no-sandbox"
          jq '{performance: .categories.performance.score, accessibility: .categories.accessibility.score, seo: .categories.seo.score, bestPractices: .categories['"'best-practices'"'].score}' lh-report.json > lh-summary.json || true

      - name: Run Axe accessibility scan
        if: always()
        run: |
          url=${{ steps.deploy.outputs.deployed_url }}
          if [ -z "$url" ] || [ "$url" = "null" ]; then
            echo "Deploy URL not available; skipping axe"
            exit 0
          fi
          npx @axe-core/cli $url --save --output-file=axe-results.json || true

      - name: Ensure artifacts exist
        if: always()
        run: |
          # Create minimal placeholders so upload step never fails
          [ -f lh-report.json ] || echo '{}' > lh-report.json
          [ -f lh-summary.json ] || echo '{}' > lh-summary.json
          [ -f axe-results.json ] || echo '{"violations":[]}' > axe-results.json

      - name: Upload LH & Axe artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-reports
          path: |
            lh-report.json
            lh-summary.json
            axe-results.json

      - name: Post PR comment with LHCI & Axe summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const pr = context.payload.pull_request.number;
            const url = process.env.DEPLOYED_URL || core.getInput('deployed_url') || (process.env.DEPLOYED_URL);
            let lh = null;
            try { lh = JSON.parse(fs.readFileSync('lh-summary.json','utf8')); } catch(e) { /* ignore */ }
            let axe = null;
            try { axe = JSON.parse(fs.readFileSync('axe-results.json','utf8')); } catch(e) { /* ignore */ }
            let body = `## CI Reports\n`;
            body += `**Staging URL:** ${{ steps.deploy.outputs.deployed_url }}\n\n`;
            if (lh) {
              body += `**Lighthouse (scores 0-1):**\n- Performance: **${lh.performance}**\n- Accessibility: **${lh.accessibility}**\n- Best Practices: **${lh.bestPractices}**\n- SEO: **${lh.seo}**\n\n`;
            } else {
              body += `Lighthouse summary not available.\n\n`;
            }
            if (axe) {
              const violations = axe.violations || [];
              body += `**Axe Violations:** ${violations.length} found. Top issues:\n`;
              violations.slice(0,3).forEach(v => {
                body += `- ${v.id}: ${v.help} (impact: ${v.impact})\n`;
              });
              body += `\n`;
            } else {
              body += `Axe results not available.\n\n`;
            }
            body += `*Full logs available in workflow run.*`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr,
              body
            });

      - name: Security scan (Snyk if configured, else npm audit)
        run: |
          if [ -n "${{ secrets.SNYK_TOKEN }}" ]; then
            npm i -g snyk
            snyk auth ${{ secrets.SNYK_TOKEN }}
            snyk test || true
          else
            npm audit --audit-level=moderate || true
          fi
